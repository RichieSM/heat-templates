heat_template_version: 2013-05-23

description: |
  Simple template to deploy a basic GlusterFS environment with 2 bricks and 2 clients

parameters:
  key-name:
    type: String
    description: Name of a nova ssh keypair to use for server access
    
  image:
    type: String
    description: Server image id to use
    default: Ubuntu 12.04 LTS (Precise Pangolin)
    constraints:
    # only tested on Ubuntu images so far
    - allowed_values:
      - Ubuntu 10.04 LTS (Lucid Lynx)
      - Ubuntu 12.04 LTS (Precise Pangolin)
      - Ubuntu 12.10 (Quantal Quetzal)
      - Ubuntu 13.04 (Raring Ringtail)
    description: must be a valid Ubuntu image id

  volume_size:
    type: Number
    description: Size of the volume to be created.
    default: 100
    constraints:
      - range: { min: 100, max: 1024 }
      description: must be between 100 and 1024 Gb.

  glusterserver_flavor:
    description: Server flavor id to use
    type: String
    default: 8GB Standard Instance
    constraints:
    - allowed_values:
      - 2GB Standard Instance
      - 4GB Standard Instance
      - 8GB Standard Instance
      - 15GB Standard Instance
      - 30GB Standard Instance 
      - 2GB Performance Instance
      - 4GB Performance Instance
      - 8GB Performance Instance
      - 15GB Performance2 Instance
      - 30GB Performance2 Instance
      - 60GB Performance2 Instance
      - 90GB Performance2 Instance
      - 120GB Performance2 Instance
      description: must be a valid Rackspace Cloud Server flavor.

 glusterclient_flavor:
    description: Client flavor id to use
    type: String
    default: 4GB Standard Instance
    constraints:
    - allowed_values:
      - 2GB Standard Instance
      - 4GB Standard Instance
      - 8GB Standard Instance
      - 15GB Standard Instance
      - 30GB Standard Instance 
      - 2GB Performance Instance
      - 4GB Performance Instance
      - 8GB Performance Instance
      - 15GB Performance2 Instance
      - 30GB Performance2 Instance
      - 60GB Performance2 Instance
      - 90GB Performance2 Instance
      - 120GB Performance2 Instance
      description: must be a valid Rackspace Cloud Server flavor.


resources:
  gluster_servers:
    type: OS::Heat::ResourceGroup
    properties: 
      count: 2
      resource_def:
        type: Rackspace::Cloud::Server
        properties:
          key_name: { get_param: key-name }
          image: { get_param: image }
          flavor: { get_param: glusterserver_flavor }
          user_data: |
            apt-get install -y build-essential
            
  gluster_bricks:
    type: OS::Heat::ResourceGroup
    properties:
      count: 2
      resource_def:
        type: OS::Cinder::Volume
        properties:
          size: { get_param: volume_size }

  volume_attachment_server1_brick1:
    type: OS::Cinder::VolumeAttachment
    properties:
      volume_id: { get_resource: gluster_bricks.[0] }
      instance_uuid: { get_resource: gluster_servers.[0] }
      mountpoint: /dev/xvdc
  volume_attachment_server2_brick2:
    type: OS::Cinder::VolumeAttachment
    properties:
      volume_id: { get_resource: gluster_bricks.[1] }
      instance_uuid: { get_resource: gluster_servers[1] }
      mountpoint: /dev/xvdc
      
  gluster_clients:
    type: OS::Heat::ResourceGroup
    properties:
      count: 2
      resource_def:
        type: Rackspace::Cloud::Server
        properties:
          key_name: { get_param: key-name }
          image: { get_param: image }
          flavor: { get_param: glusterclient_flavor }
          user_data: |
            apt-get install -y build-essential
      
outputs:
  ssh:
    value: 
      str_replace:
        template: ssh root@%host%
        params:
          "%host%":
          get_attr:
          - PublicIp
    description: ssh to the gluster hosts
    
  verify:
    value:
      str_replace:
        template: ssh root@%host%
        params:
          "%host%":
          get_attr:
          - PublicIp
    description: ssh to gluster hosts
